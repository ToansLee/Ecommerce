@{
    ViewData["Title"] = "Tr·ª£ l√Ω AI - T∆∞ v·∫•n m√≥n ƒÉn";
    Layout = "_LayoutCustomer";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg" style="border-radius: 20px; border: 2px solid #FFE5CC;">
                <!-- Header -->
                <div class="card-header text-white text-center py-3" style="background: linear-gradient(135deg, #FF9500 0%, #FF7C1F 100%); border-radius: 18px 18px 0 0;">
                    <h4 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Tr·ª£ l√Ω AI - T∆∞ v·∫•n m√≥n ƒÉn
                    </h4>
                    <small>Powered by Google Gemini</small>
                </div>

                <!-- Chat Messages -->
                <div class="card-body" style="height: 500px; overflow-y: auto; background: #FFF8F0;" id="chatContainer">
                    <div id="chatMessages">
                        <!-- Messages will be appended here -->
                    </div>
                </div>

                <!-- Input Area -->
                <div class="card-footer" style="background: white; border-radius: 0 0 18px 18px;">
                    <div class="row g-2">
                        <div class="col">
                            <textarea id="userMessage" class="form-control" rows="2" placeholder="H·ªèi t√¥i v·ªÅ m√≥n ƒÉn... VD: 'H√¥m nay ƒÉn g√¨?', 'G·ª£i √Ω m√≥n cay', 'M√≥n gi√° r·∫ª'..." style="border: 2px solid #FFE5CC; border-radius: 10px;"></textarea>
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            <button id="sendBtn" class="btn text-white" style="background: linear-gradient(135deg, #FF9500 0%, #FF7C1F 100%); border-radius: 10px; padding: 12px 24px;" onclick="sendMessage()">
                                <i class="fas fa-paper-plane me-2"></i>G·ª≠i
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <a href="@Url.Action("Index", "Chat")" class="btn btn-outline-secondary btn-sm" style="border-radius: 10px;">
                            <i class="fas fa-comments me-2"></i>Chat v·ªõi nh√¢n vi√™n
                        </a>
                        <button class="btn btn-outline-danger btn-sm ms-2" style="border-radius: 10px;" onclick="clearChat()">
                            <i class="fas fa-trash me-2"></i>X√≥a l·ªãch s·ª≠
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Suggestions -->
            <div class="mt-4">
                <h6 class="text-center mb-3" style="color: #FF9500;">G·ª£i √Ω c√¢u h·ªèi:</h6>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <button class="btn btn-outline-warning btn-sm" style="border-radius: 20px;" onclick="quickQuestion('H√¥m nay ƒÉn g√¨?')">
                        ü§î H√¥m nay ƒÉn g√¨?
                    </button>
                    <button class="btn btn-outline-warning btn-sm" style="border-radius: 20px;" onclick="quickQuestion('G·ª£i √Ω m√≥n cay')">
                        üå∂Ô∏è M√≥n cay
                    </button>
                    <button class="btn btn-outline-warning btn-sm" style="border-radius: 20px;" onclick="quickQuestion('M√≥n gi√° r·∫ª d∆∞·ªõi 50k')">
                        üí∞ Gi√° r·∫ª
                    </button>
                    <button class="btn btn-outline-warning btn-sm" style="border-radius: 20px;" onclick="quickQuestion('M√≥n Vi·ªát Nam')">
                        üáªüá≥ M√≥n Vi·ªát
                    </button>
                    <button class="btn btn-outline-warning btn-sm" style="border-radius: 20px;" onclick="quickQuestion('M√≥n healthy')">
                        ü•ó Healthy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let chatHistory = [];

        $(document).ready(function() {
            loadChatHistory();
            
            // Load greeting message
            loadGreeting();

            // Enter to send
            $('#userMessage').keypress(function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        function loadGreeting() {
            $.get('@Url.Action("GetBotGreeting", "Chat")', function(response) {
                if (response.success) {
                    addBotMessage(response.greeting);
                }
            });
        }

        function sendMessage() {
            let message = $('#userMessage').val().trim();
            if (!message) return;

            // Add user message
            addUserMessage(message);
            $('#userMessage').val('');

            // Show loading
            let loadingId = addLoadingMessage();

            // Send to bot
            $.ajax({
                url: '@Url.Action("ChatWithBot", "Chat")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ message: message }),
                success: function(response) {
                    removeLoadingMessage(loadingId);
                    if (response.success) {
                        addBotMessage(response.response);
                    } else {
                        addBotMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i! üò¢');
                    }
                },
                error: function() {
                    removeLoadingMessage(loadingId);
                    addBotMessage('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i! üò¢');
                }
            });
        }

        function addUserMessage(text) {
            let msg = {
                type: 'user',
                text: text,
                time: new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            };
            chatHistory.push(msg);
            saveChatHistory();
            renderMessage(msg);
            scrollToBottom();
        }

        function addBotMessage(text) {
            let msg = {
                type: 'bot',
                text: text,
                time: new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            };
            chatHistory.push(msg);
            saveChatHistory();
            renderMessage(msg);
            scrollToBottom();
        }

        function addLoadingMessage() {
            let id = 'loading-' + Date.now();
            let html = `
                <div id="${id}" class="d-flex justify-content-start mb-3">
                    <div class="bg-light rounded p-3" style="max-width: 70%; border: 1px solid #FFE5CC;">
                        <div class="spinner-border spinner-border-sm text-warning me-2" role="status"></div>
                        <span class="text-muted">ƒêang suy nghƒ©...</span>
                    </div>
                </div>
            `;
            $('#chatMessages').append(html);
            scrollToBottom();
            return id;
        }

        function removeLoadingMessage(id) {
            $('#' + id).remove();
        }

        function renderMessage(msg) {
            let alignment = msg.type === 'user' ? 'justify-content-end' : 'justify-content-start';
            let bgColor = msg.type === 'user' ? 'background: linear-gradient(135deg, #FF9500 0%, #FF7C1F 100%); color: white;' : 'background: white; border: 1px solid #FFE5CC;';
            let icon = msg.type === 'bot' ? '<i class="fas fa-robot me-2" style="color: #FF9500;"></i>' : '';
            
            let html = `
                <div class="d-flex ${alignment} mb-3 animate__animated animate__fadeInUp">
                    <div class="rounded p-3" style="max-width: 70%; ${bgColor}">
                        ${icon}
                        <div style="white-space: pre-wrap;">${escapeHtml(msg.text)}</div>
                        <small class="d-block mt-2 opacity-75" style="font-size: 0.75rem;">${msg.time}</small>
                    </div>
                </div>
            `;
            $('#chatMessages').append(html);
        }

        function scrollToBottom() {
            $('#chatContainer').animate({
                scrollTop: $('#chatContainer')[0].scrollHeight
            }, 300);
        }

        function quickQuestion(question) {
            $('#userMessage').val(question);
            sendMessage();
        }

        function clearChat() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ chat?')) {
                chatHistory = [];
                localStorage.removeItem('chatbot_history');
                $('#chatMessages').html('');
                loadGreeting();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatbot_history', JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            let saved = localStorage.getItem('chatbot_history');
            if (saved) {
                chatHistory = JSON.parse(saved);
                chatHistory.forEach(msg => renderMessage(msg));
                scrollToBottom();
            }
        }

        function escapeHtml(text) {
            let div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
}

<style>
    #chatContainer::-webkit-scrollbar {
        width: 8px;
    }

    #chatContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    #chatContainer::-webkit-scrollbar-thumb {
        background: #FF9500;
        border-radius: 10px;
    }

    #chatContainer::-webkit-scrollbar-thumb:hover {
        background: #FF7C1F;
    }
</style>
