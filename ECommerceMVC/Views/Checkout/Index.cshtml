@model ECommerceMVC.Models.Cart
@{
    ViewData["Title"] = "Thanh toán";
    var cartTotal = Model.CartItems.Sum(ci => ci.Quantity * ci.Price);
    var shippingFee = cartTotal >= 500000 ? 0 : 35000;
    var total = cartTotal + shippingFee;
}

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5" style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.9) 0%, rgba(245, 169, 96, 0.9) 100%), url('/img/cart-page-header-img.jpg') center center/cover no-repeat;">
    <h1 class="text-center text-white display-4 fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);"><i class="fa fa-credit-card me-3"></i>Thanh toán</h1>
    <ol class="breadcrumb justify-content-center mb-0" style="background-color: rgba(255, 255, 255, 0.2); padding: 12px 24px; border-radius: 50px; backdrop-filter: blur(10px);">
        <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Home" style="color: white; text-decoration: none; font-weight: 500; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); transition: all 0.3s;" onmouseover="this.style.color='#FFF4E6'" onmouseout="this.style.color='white'">Trang chủ</a></li>
        <li class="breadcrumb-item"><a asp-action="Index" asp-controller="Cart" style="color: white; text-decoration: none; font-weight: 500; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); transition: all 0.3s;" onmouseover="this.style.color='#FFF4E6'" onmouseout="this.style.color='white'">Giỏ hàng</a></li>
        <li class="breadcrumb-item active" style="color: white; font-weight: 600; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">Thanh toán</li>
    </ol>
</div>
<!-- Single Page Header End -->

<!-- Checkout Start -->
<div class="container-fluid py-5" style="background-color: #f8f9fa;">
    <div class="container py-5">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert" style="border-left: 5px solid #DC3545; border-radius: 10px;">
                <i class="fa fa-exclamation-circle me-2"></i>@TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <form asp-action="ProcessPayment" asp-controller="Checkout" method="post">
            <div class="row g-5">
                <div class="col-md-12 col-lg-6 col-xl-7">
                    <div class="shadow-lg" style="background: linear-gradient(135deg, #FFFFFF 0%, #FFF8F0 100%); border-radius: 20px; border: 2px solid #FF9500;">
                        <div class="p-4" style="background: linear-gradient(135deg, #FF9500 0%, #FFB84D 100%); border-radius: 18px 18px 0 0;">
                            <h3 class="mb-0 text-white fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);"><i class="fa fa-shipping-fast me-2"></i>Thông tin giao hàng</h3>
                        </div>
                        <div class="p-4">
                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #2C3E50;"><i class="fa fa-user me-2 text-warning"></i>Họ tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" value="@User.Identity?.Name" readonly style="border: 2px solid #E0E0E0; border-radius: 10px; background-color: #F5F5F5; padding: 12px;">
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #2C3E50;"><i class="fa fa-map-marker-alt me-2 text-danger"></i>Địa chỉ giao hàng <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="deliveryAddress" rows="3" placeholder="Nhập địa chỉ chi tiết để giao hàng" required style="border: 2px solid #E0E0E0; border-radius: 10px; padding: 12px;"></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #2C3E50;"><i class="fa fa-sticky-note me-2 text-info"></i>Ghi chú đơn hàng (Tùy chọn)</label>
                                <textarea class="form-control" name="notes" rows="3" placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn." style="border: 2px solid #E0E0E0; border-radius: 10px; padding: 12px;"></textarea>
                            </div>

                            <!-- Hiển thị hạng thành viên -->
                            <div class="alert" style="background: linear-gradient(135deg, #FFE5CC 0%, #FFD4A3 100%); border: none; border-radius: 15px; border-left: 5px solid #FF9500;">
                                <i class="fas fa-crown me-2" style="color: #FF9500;"></i>
                                <strong>Hạng thành viên:</strong> <span style="color: #FF9500; font-weight: 600;">@ViewBag.CustomerTier</span>
                                <br>
                                <small class="text-muted">Bạn được giảm @ViewBag.DiscountPercentage% cho đơn hàng này</small>
                            </div>

                            <!-- Hiển thị số dư ví -->
                            @if (ViewBag.WalletBalance > 0)
                            {
                                <div class="alert alert-success" style="background-color: #E8F5E9; border: none; border-radius: 15px; border-left: 5px solid #4CAF50;">
                                    <i class="fas fa-wallet me-2" style="color: #4CAF50;"></i>
                                    <strong>Số dư ví:</strong> @ViewBag.WalletBalance.ToString("N0") VNĐ
                                    <br>
                                    <small class="text-muted">Số dư ví sẽ được tự động trừ vào đơn hàng</small>
                                </div>
                            }

                            <!-- Phương thức thanh toán -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold" style="color: #2C3E50;">
                                    <i class="fas fa-credit-card me-2 text-primary"></i>Chọn phương thức thanh toán
                                </label>
                                <div class="payment-methods">
                                    <div class="form-check mb-3 p-3" style="border: 2px solid #E0E0E0; border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.borderColor='#FF9500'" onmouseout="this.style.borderColor='#E0E0E0'">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="codPayment" value="COD" checked style="width: 20px; height: 20px;">
                                        <label class="form-check-label ms-2" for="codPayment" style="cursor: pointer;">
                                            <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                            <strong>Thanh toán khi nhận hàng (COD)</strong>
                                            <br>
                                            <small class="text-muted">Thanh toán bằng tiền mặt khi nhận hàng</small>
                                        </label>
                                    </div>

                                    <div class="form-check p-3" style="border: 2px solid #E0E0E0; border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.borderColor='#FF9500'" onmouseout="this.style.borderColor='#E0E0E0'">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="vnpayPayment" value="VNPay" style="width: 20px; height: 20px;">
                                        <label class="form-check-label ms-2" for="vnpayPayment" style="cursor: pointer;">
                                            <i class="fas fa-qrcode me-2 text-primary"></i>
                                            <strong>Thanh toán qua VNPay</strong>
                                            <br>
                                            <small class="text-muted">Thanh toán trực tuyến qua cổng VNPay</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 col-lg-6 col-xl-5">
                    <div class="shadow-lg" style="background: linear-gradient(135deg, #FFFFFF 0%, #FFF8F0 100%); border-radius: 20px; border: 2px solid #FF9500;">
                        <div class="p-4" style="background: linear-gradient(135deg, #FF9500 0%, #FFB84D 100%); border-radius: 18px 18px 0 0;">
                            <h3 class="mb-0 text-white fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);"><i class="fa fa-receipt me-2"></i>Chi tiết đơn hàng</h3>
                        </div>
                        <div class="p-4">
                            <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                @foreach (var item in Model.CartItems)
                                {
                                    <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 2px dashed #E0E0E0;">
                                        <div class="d-flex align-items-center">
                                            <img src="~/Hinh/HangHoa/@item.MenuItem.Image" class="img-fluid rounded shadow-sm" style="width: 70px; height: 70px; object-fit: cover; border: 2px solid #FF9500;" alt="@item.MenuItem.Name">
                                            <div class="ms-3">
                                                <p class="mb-0 fw-bold" style="color: #2C3E50; font-size: 0.95rem;">@item.MenuItem.Name</p>
                                                <small class="text-muted"><i class="fa fa-shopping-cart me-1"></i>Số lượng: <strong>@item.Quantity</strong></small>
                                            </div>
                                        </div>
                                        <p class="mb-0 fw-bold" style="color: #27AE60; font-size: 1.05rem;">@((item.Quantity * item.Price).ToString("N0")) VNĐ</p>
                                    </div>
                                }
                            </div>

                            <hr style="border-top: 2px solid #E0E0E0;">

                            <div class="d-flex justify-content-between mb-3">
                                <h6 class="mb-0 fw-semibold" style="color: #2C3E50;"><i class="fa fa-list-alt me-2 text-warning"></i>Tạm tính:</h6>
                                <p class="mb-0 fw-bold" style="color: #FF9500; font-size: 1.1rem;">@cartTotal.ToString("N0") VNĐ</p>
                            </div>

                            <div class="d-flex justify-content-between mb-3">
                                <h6 class="mb-0 fw-semibold" style="color: #2C3E50;"><i class="fa fa-truck me-2 text-info"></i>Phí vận chuyển:</h6>
                                <p class="mb-0 fw-bold" style="color: #3498DB; font-size: 1.05rem;">@(shippingFee == 0 ? "Miễn phí" : shippingFee.ToString("N0") + " VNĐ")</p>
                            </div>

                            @if (ViewBag.DiscountPercentage != null && ViewBag.DiscountPercentage > 0)
                            {
                                var subtotal = cartTotal + shippingFee;
                                var discount = subtotal * (decimal)ViewBag.DiscountPercentage;
                                <div class="d-flex justify-content-between mb-3">
                                    <h6 class="mb-0 fw-semibold" style="color: #2C3E50;"><i class="fa fa-crown me-2" style="color: #FFD700;"></i>Giảm giá hạng thành viên:</h6>
                                    <p class="mb-0 fw-bold" style="color: #E74C3C; font-size: 1.05rem;">-@discount.ToString("N0") VNĐ</p>
                                </div>
                            }

                            @if (cartTotal < 500000 && cartTotal > 0)
                            {
                                <div class="alert alert-info mb-3" style="background-color: #E3F2FD; border: none; border-radius: 10px;">
                                    <i class="fa fa-info-circle me-2"></i>
                                    <small>Mua thêm <strong>@((500000 - cartTotal).ToString("N0")) VNĐ</strong> để được miễn phí vận chuyển!</small>
                                </div>
                            }

                            <hr style="border-top: 2px solid #FF9500;">

                            <div class="d-flex justify-content-between mb-4 p-3" style="background-color: #FFF4E6; border-radius: 10px;">
                                <h4 class="mb-0 fw-bold" style="color: #2C3E50;"><i class="fa fa-money-bill-wave me-2 text-success"></i>Tổng cộng:</h4>
                                <h3 class="mb-0 fw-bold" style="color: #27AE60;">@total.ToString("N0") VNĐ</h3>
                            </div>

                            <button type="submit" class="btn w-100 py-3 text-white shadow" style="background: linear-gradient(135deg, #27AE60 0%, #2ECC71 100%); border: none; border-radius: 15px; font-weight: 700; font-size: 1.1rem; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fa fa-check-circle me-2"></i>Xác nhận thanh toán
                            </button>

                            <a asp-action="Index" asp-controller="Cart" class="btn btn-outline-secondary w-100 py-3 mt-3" style="border-radius: 15px; border: 2px solid #95A5A6; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.backgroundColor='#95A5A6'; this.style.color='white'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#6C757D'">
                                <i class="fa fa-arrow-left me-2"></i>Quay lại giỏ hàng
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Checkout End -->
